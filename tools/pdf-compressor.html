<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PDF Compressor – Rahul Tools</title>

  <!-- pdf.js (render pages) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <!-- jsPDF (build new PDF from images) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body{ font-family: Arial, sans-serif; padding:18px; max-width:1100px; margin:0 auto; }
    .muted{ opacity:.7; font-size:14px; }
    .tool{ margin-top:14px; border:1px solid #e7e7e7; border-radius:14px; padding:16px; }
    .controls{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; margin-top:12px; }
    @media (max-width:900px){ .controls{ grid-template-columns:1fr; } }
    label{ font-size:14px; opacity:.9; display:block; margin-bottom:6px; }
    input[type="file"], select, input[type="range"]{
      width:100%; padding:10px; border-radius:10px; border:1px solid #ddd; box-sizing:border-box; background:#fff;
    }
    input[type="range"]{ padding:0; }
    .actions{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    button{ padding:10px 14px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    button.primary{ border-color:#111; background:#111; color:#fff; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .note{ margin-top:10px; font-size:13px; opacity:.75; line-height:1.4; }
    .previewWrap{ margin-top:14px; display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
    .card{ border:1px solid #eee; border-radius:14px; padding:12px; min-width:260px; }
    .stat{ display:flex; justify-content:space-between; gap:10px; font-size:13px; margin:6px 0; opacity:.9; }
    progress{ width:100%; height:14px; }
    .thumb{
      width: 220px; height: 280px; background:#f7f7f7; border:1px solid #eee; border-radius:12px;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    .thumb canvas{ width:100%; height:100%; object-fit:cover; }
  </style>
</head>

<a href="../index.html">← Back to Home</a>

<body>

  <div>
    <div class="muted">© Rahul Negi 2026</div>
    <h1 style="margin:6px 0 0 0;">PDF Compressor</h1>
    <div class="muted">Browser-based compression by re-rendering pages to lower DPI images.</div>
  </div>

  <div class="tool">
    <label>Upload PDF</label>
    <input type="file" id="pdfFile" accept="application/pdf" />

    <div class="controls">
      <div>
        <label>Quality (JPEG): <span id="qLabel">0.70</span></label>
        <input type="range" id="quality" min="0.3" max="0.95" step="0.05" value="0.70" />
      </div>

      <div>
        <label>Render scale (DPI-ish)</label>
        <select id="scale">
          <option value="1.0">Low (scale 1.0) – smallest</option>
          <option value="1.25">Medium (scale 1.25)</option>
          <option value="1.5" selected>High (scale 1.5) – balanced</option>
          <option value="2.0">Very High (scale 2.0) – bigger</option>
        </select>
      </div>

      <div>
        <label>Mode</label>
        <select id="mode">
          <option value="color" selected>Color</option>
          <option value="grayscale">Grayscale (smaller for scans)</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button class="primary" id="compressBtn" onclick="compressPDF()" disabled>Compress PDF</button>
      <button id="downloadBtn" onclick="downloadCompressed()" disabled>Download Compressed</button>
      <button onclick="resetAll()">Clear</button>
    </div>

    <div class="note">
      ✅ Best for scanned/image-heavy PDFs. <br/>
      ⚠️ Output PDF me text selectable/searchable nahi rahega (pages images ban jaate hain). Text-heavy PDFs me kabhi-kabhi size ulta badh bhi sakta hai.
    </div>

    <div class="previewWrap">
      <div class="card">
        <div style="font-weight:600; margin-bottom:8px;">Status</div>
        <div class="stat"><span>Original size</span><span id="origSize">—</span></div>
        <div class="stat"><span>Pages</span><span id="pageCount">—</span></div>
        <div class="stat"><span>Compressed size</span><span id="newSize">—</span></div>
        <div class="stat"><span>Saved</span><span id="savedPct">—</span></div>
        <progress id="prog" value="0" max="100"></progress>
        <div class="muted" id="progText" style="margin-top:6px;">Idle</div>
      </div>

      <div class="card">
        <div style="font-weight:600; margin-bottom:8px;">Preview (page 1)</div>
        <div class="thumb" id="thumb">
          <span class="muted">No PDF</span>
        </div>
      </div>
    </div>
  </div>

<script>
  // pdf.js worker (CDN)
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  const pdfFileEl = document.getElementById("pdfFile");
  const compressBtn = document.getElementById("compressBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  const qualityEl = document.getElementById("quality");
  const qLabel = document.getElementById("qLabel");
  const scaleEl = document.getElementById("scale");
  const modeEl = document.getElementById("mode");

  const origSizeEl = document.getElementById("origSize");
  const pageCountEl = document.getElementById("pageCount");
  const newSizeEl = document.getElementById("newSize");
  const savedPctEl = document.getElementById("savedPct");
  const prog = document.getElementById("prog");
  const progText = document.getElementById("progText");
  const thumb = document.getElementById("thumb");

  let originalFile = null;
  let compressedBlob = null;

  qualityEl.addEventListener("input", () => qLabel.textContent = Number(qualityEl.value).toFixed(2));

  pdfFileEl.addEventListener("change", async (e) => {
    resetOutputOnly();
    const f = e.target.files?.[0];
    if (!f) return;

    if (f.type !== "application/pdf") {
      alert("Please select a PDF file.");
      pdfFileEl.value = "";
      return;
    }

    originalFile = f;
    origSizeEl.textContent = bytesToNice(f.size);
    compressBtn.disabled = false;

    // Render first page preview + page count
    try {
      progText.textContent = "Reading PDF…";
      const buf = await f.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      pageCountEl.textContent = pdf.numPages;

      const page1 = await pdf.getPage(1);
      const canvas = document.createElement("canvas");
      const viewport = page1.getViewport({ scale: 0.6 });
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      const ctx = canvas.getContext("2d");
      await page1.render({ canvasContext: ctx, viewport }).promise;

      thumb.innerHTML = "";
      thumb.appendChild(canvas);

      progText.textContent = "Ready";
      prog.value = 0;
    } catch (err) {
      console.error(err);
      progText.textContent = "Failed to read PDF.";
      alert("PDF read error. Try another PDF.");
    }
  });

  function bytesToNice(b){
    const kb = b / 1024;
    if (kb < 1024) return kb.toFixed(1) + " KB";
    const mb = kb / 1024;
    return mb.toFixed(2) + " MB";
  }

  function resetOutputOnly(){
    compressedBlob = null;
    newSizeEl.textContent = "—";
    savedPctEl.textContent = "—";
    downloadBtn.disabled = true;
    prog.value = 0;
  }

  function resetAll(){
    originalFile = null;
    compressedBlob = null;
    pdfFileEl.value = "";
    compressBtn.disabled = true;
    downloadBtn.disabled = true;
    origSizeEl.textContent = "—";
    pageCountEl.textContent = "—";
    newSizeEl.textContent = "—";
    savedPctEl.textContent = "—";
    prog.value = 0;
    progText.textContent = "Idle";
    thumb.innerHTML = `<span class="muted">No PDF</span>`;
  }

  async function compressPDF(){
    if (!originalFile) return;

    compressBtn.disabled = true;
    downloadBtn.disabled = true;
    prog.value = 0;

    const quality = Number(qualityEl.value);
    const scale = Number(scaleEl.value);
    const mode = modeEl.value;

    try {
      progText.textContent = "Loading PDF…";
      const buf = await originalFile.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;

      const { jsPDF } = window.jspdf;

      let outPdf = null;

      for (let p = 1; p <= pdf.numPages; p++) {
        progText.textContent = `Rendering page ${p}/${pdf.numPages}…`;
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({ scale });

        const canvas = document.createElement("canvas");
        canvas.width = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        const ctx = canvas.getContext("2d");

        await page.render({ canvasContext: ctx, viewport }).promise;

        // optional grayscale
        if (mode === "grayscale") {
          const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imgData.data;
          for (let i = 0; i < data.length; i += 4) {
            const r = data[i], g = data[i+1], b = data[i+2];
            const y = (0.299*r + 0.587*g + 0.114*b) | 0;
            data[i] = data[i+1] = data[i+2] = y;
          }
          ctx.putImageData(imgData, 0, 0);
        }

        // Convert canvas to JPEG dataURL for smaller size
        const dataUrl = canvas.toDataURL("image/jpeg", quality);

        const w = canvas.width;
        const h = canvas.height;

        if (!outPdf) {
          outPdf = new jsPDF({
            orientation: w >= h ? "l" : "p",
            unit: "px",
            format: [w, h]
          });
        } else {
          outPdf.addPage([w, h], w >= h ? "l" : "p");
        }

        outPdf.addImage(dataUrl, "JPEG", 0, 0, w, h);

        prog.value = Math.round((p / pdf.numPages) * 100);
      }

      progText.textContent = "Finalizing…";
      const outBlob = outPdf.output("blob");
      compressedBlob = outBlob;

      const orig = originalFile.size;
      const neu = outBlob.size;
      newSizeEl.textContent = bytesToNice(neu);

      const saved = orig ? (100 - (neu / orig * 100)) : 0;
      savedPctEl.textContent = `${saved.toFixed(1)}%`;

      progText.textContent = "Done ✅";
      downloadBtn.disabled = false;
    } catch (err) {
      console.error(err);
      progText.textContent = "Compression failed.";
      alert("Compression failed. If PDF is huge, try lower scale (1.0) and quality (0.6).");
    } finally {
      compressBtn.disabled = false;
    }
  }

  function downloadCompressed(){
    if (!compressedBlob) return;
    const a = document.createElement("a");
    const url = URL.createObjectURL(compressedBlob);
    a.href = url;
    const base = originalFile?.name?.replace(/\.pdf$/i,"") || "file";
    a.download = `${base}-compressed.pdf`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
</script>

</body>
</html>
