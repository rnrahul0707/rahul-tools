<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Watermark + Page Number ‚Äì Rahul Tools</title>

<!-- Smooth reorder -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>

<!-- PDF edit/create -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

<style>
  body{
    margin:0;
    font-family: Arial, sans-serif;
    background:#fff;
    color:#222;
    padding:20px;
  }
  .wrap{ max-width:1100px; margin:0 auto; }
  h1{ margin:6px 0; }
  .muted{ color:#666; font-size:14px; }

  .panel{
    border:1px solid #e6e6e6;
    border-radius:14px;
    padding:14px;
    margin-top:14px;
  }

  .toolbar{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:space-between;
    align-items:center;
  }

  .fileBtn{
    position:relative;
    padding:10px 14px;
    border-radius:10px;
    border:1px solid #ccc;
    background:#f9f9f9;
    cursor:pointer;
    display:inline-flex;
    gap:8px;
    align-items:center;
  }
  .fileBtn input{
    position:absolute;
    inset:0;
    opacity:0;
    cursor:pointer;
  }

  button{
    padding:10px 14px;
    border-radius:10px;
    border:1px solid #ccc;
    background:#f9f9f9;
    cursor:pointer;
  }
  button.primary{
    background:#111;
    color:#fff;
    border-color:#111;
  }
  button:disabled{
    opacity:0.55;
    cursor:not-allowed;
  }

  .gridControls{
    margin-top:12px;
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:12px;
  }
  @media(max-width:900px){ .gridControls{ grid-template-columns:1fr; } }

  .field label{
    display:block;
    font-size:13px;
    color:#444;
    margin-bottom:6px;
  }
  .field input[type="text"],
  .field input[type="number"],
  .field select{
    width:100%;
    padding:10px;
    border-radius:10px;
    border:1px solid #ddd;
    background:#fff;
    box-sizing:border-box;
  }
  .field input[type="range"]{ width:100%; }

  .hint{
    margin-top:10px;
    font-size:13px;
    color:#666;
    line-height:1.45;
  }

  /* File list */
  .list{
    margin-top:14px;
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:12px;
  }
  @media(max-width:900px){ .list{ grid-template-columns: repeat(2, 1fr);} }
  @media(max-width:520px){ .list{ grid-template-columns: 1fr;} }

  .card{
    border:1px solid #e6e6e6;
    border-radius:12px;
    overflow:hidden;
    background:#fff;
    position:relative;
  }
  .thumb{
    width:100%;
    height:150px;
    object-fit:cover;
    background:#f3f3f3;
    display:block;
  }
  .meta{
    padding:10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .name{
    font-size:12px;
    color:#555;
    overflow:hidden;
    white-space:nowrap;
    text-overflow:ellipsis;
    max-width:80%;
  }
  .iconBtn{ cursor:pointer; font-size:16px; }

  .handle{
    position:absolute;
    top:8px;
    left:8px;
    background:#fff;
    border:1px solid #ddd;
    padding:4px 6px;
    font-size:12px;
    border-radius:6px;
    cursor:grab;
    user-select:none;
  }
  .badge{
    position:absolute;
    top:8px;
    right:8px;
    background:#fff;
    border:1px solid #ddd;
    padding:4px 10px;
    font-size:12px;
    border-radius:999px;
    color:#666;
  }

  .pdfBox{
    height:150px;
    background:linear-gradient(180deg,#f7f7f7,#efefef);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:44px;
  }

  .statusRow{
    margin-top:10px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
  }
  .pill{
    font-size:13px;
    color:#666;
    background:#f6f6f6;
    border:1px solid #e7e7e7;
    padding:8px 10px;
    border-radius:999px;
  }
  progress{ width:100%; height:14px; }
</style>
</head>

<a href="../index.html">‚Üê Back to Home</a>

<body>
<div class="wrap">
  <div>
    <div class="muted">¬© Rahul Negi 2026</div>
    <h1>Watermark + Page Number</h1>
    <div class="muted">Upload Images + PDFs ‚Üí reorder ‚Üí export single PDF with watermark & footer on every page.</div>
  </div>

  <div class="panel">
    <div class="toolbar">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <label class="fileBtn">
          üìÅ Upload (Images + PDFs)
          <input type="file" id="files" accept="image/*,application/pdf" multiple>
        </label>
        <button onclick="clearAll()">Clear</button>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="primary" id="createBtn" onclick="createOutputPDF()" disabled>Create PDF</button>
      </div>
    </div>

    <div class="gridControls">
      <div class="field">
        <label>Watermark text</label>
        <input type="text" id="wmText" placeholder="CONFIDENTIAL / Rahul Tools" />
      </div>

      <div class="field">
        <label>Watermark position</label>
        <select id="wmPos">
          <option value="top-left">Top Left</option>
          <option value="top-center">Top Center</option>
          <option value="top-right">Top Right</option>
          <option value="mid-left">Middle Left</option>
          <option value="center" selected>Center</option>
          <option value="mid-right">Middle Right</option>
          <option value="bottom-left">Bottom Left</option>
          <option value="bottom-center">Bottom Center</option>
          <option value="bottom-right">Bottom Right</option>
        </select>
      </div>

      <div class="field">
        <label>Watermark rotation (degrees)</label>
        <input type="number" id="wmRotate" value="45" step="1" />
      </div>

      <div class="field">
        <label>Watermark opacity: <span id="wmOpacityLabel">0.20</span></label>
        <input type="range" id="wmOpacity" min="0.05" max="1" step="0.05" value="0.20" />
      </div>

      <div class="field">
        <label>Watermark size</label>
        <select id="wmSizeMode">
          <option value="auto" selected>Auto (recommended)</option>
          <option value="custom">Custom</option>
        </select>
        <div style="margin-top:8px;">
          <input type="number" id="wmFontSize" value="48" min="8" step="1" disabled />
          <div class="muted" style="margin-top:6px;">(Auto uses page size. Custom uses this number.)</div>
        </div>
      </div>

      <div class="field">
        <label>Page numbers</label>
        <select id="pnType">
          <option value="none">None</option>
          <option value="page" selected>Page X</option>
          <option value="pageof">Page X of Y</option>
        </select>
        <div style="margin-top:8px;">
          <label style="margin:0 0 6px 0;">Position</label>
          <select id="pnPos">
            <option value="bottom-left">Bottom Left</option>
            <option value="bottom-center" selected>Bottom Center</option>
            <option value="bottom-right">Bottom Right</option>
            <option value="top-left">Top Left</option>
            <option value="top-center">Top Center</option>
            <option value="top-right">Top Right</option>
          </select>
        </div>
        <div style="margin-top:8px;">
          <label style="margin:0 0 6px 0;">Font size</label>
          <input type="number" id="pnFontSize" value="12" min="8" max="30" step="1" />
        </div>
      </div>
    </div>

    <div class="statusRow">
      <div class="pill" id="statusPill">No files selected</div>
      <div class="pill" id="pagesPill">Total pages: ‚Äî</div>
    </div>

    <div style="margin-top:10px;">
      <progress id="prog" value="0" max="100"></progress>
      <div class="muted" id="progText" style="margin-top:6px;">Idle</div>
    </div>

    <div class="hint">
      ‚Ä¢ Drag handle ‚Äúdrag‚Äù se order change karo (smooth).<br/>
      ‚Ä¢ Output PDF me watermark + page number <b>har page</b> pe apply hoga (images + PDFs dono).
    </div>

    <div class="list" id="list"></div>
  </div>
</div>

<script>
  const { PDFDocument, StandardFonts, rgb, degrees } = PDFLib;

  const filesEl = document.getElementById("files");
  const listEl = document.getElementById("list");
  const createBtn = document.getElementById("createBtn");

  const statusPill = document.getElementById("statusPill");
  const pagesPill = document.getElementById("pagesPill");

  const prog = document.getElementById("prog");
  const progText = document.getElementById("progText");

  const wmOpacity = document.getElementById("wmOpacity");
  const wmOpacityLabel = document.getElementById("wmOpacityLabel");
  const wmSizeMode = document.getElementById("wmSizeMode");
  const wmFontSize = document.getElementById("wmFontSize");

  let items = []; // {id, file, kind, url?}
  let sortable = null;

  wmOpacity.addEventListener("input", () => {
    wmOpacityLabel.textContent = Number(wmOpacity.value).toFixed(2);
  });

  wmSizeMode.addEventListener("change", () => {
    wmFontSize.disabled = (wmSizeMode.value !== "custom");
  });

  filesEl.addEventListener("change", (e) => {
    clearListOnly();

    const files = Array.from(e.target.files || []);
    if (!files.length) return;

    items = files.map((file, idx) => {
      const isPdf = (file.type === "application/pdf") || file.name.toLowerCase().endsWith(".pdf");
      const kind = isPdf ? "pdf" : "image";
      const url = (kind === "image") ? URL.createObjectURL(file) : null;
      return {
        id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + idx)),
        file,
        kind,
        url
      };
    });

    render();
    initSortable();
    updateStatus();
    createBtn.disabled = items.length === 0;
    pagesPill.textContent = "Total pages: (will calculate on export)";
  });

  function updateStatus(){
    if (!items.length) {
      statusPill.textContent = "No files selected";
    } else {
      const imgCount = items.filter(i => i.kind === "image").length;
      const pdfCount = items.filter(i => i.kind === "pdf").length;
      statusPill.textContent = `${items.length} file(s) ‚Ä¢ ${imgCount} image ‚Ä¢ ${pdfCount} PDF ‚Ä¢ drag to reorder`;
    }
  }

  function clearListOnly(){
    // revoke any old image URLs
    items.forEach(it => { if (it.url) URL.revokeObjectURL(it.url); });
    items = [];
    listEl.innerHTML = "";
    if (sortable) sortable.destroy();
    sortable = null;
    prog.value = 0;
    progText.textContent = "Idle";
    updateStatus();
  }

  function clearAll(){
    clearListOnly();
    filesEl.value = "";
    createBtn.disabled = true;
    pagesPill.textContent = "Total pages: ‚Äî";
  }

  function removeAt(idx){
    const it = items[idx];
    if (it?.url) URL.revokeObjectURL(it.url);
    items.splice(idx, 1);
    render();
    initSortable();
    updateStatus();
    createBtn.disabled = items.length === 0;
  }

  function render(){
    listEl.innerHTML = "";
    items.forEach((it, idx) => {
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.id = it.id;

      const handle = document.createElement("div");
      handle.className = "handle";
      handle.textContent = "drag";

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = `#${idx + 1}`;

      card.appendChild(handle);
      card.appendChild(badge);

      if (it.kind === "image") {
        const img = document.createElement("img");
        img.className = "thumb";
        img.src = it.url;
        img.alt = it.file.name;
        card.appendChild(img);
      } else {
        const pdfBox = document.createElement("div");
        pdfBox.className = "pdfBox";
        pdfBox.textContent = "üìÑ";
        card.appendChild(pdfBox);
      }

      const meta = document.createElement("div");
      meta.className = "meta";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = it.file.name;

      const del = document.createElement("div");
      del.className = "iconBtn";
      del.title = "Remove";
      del.textContent = "üóë";
      del.onclick = () => removeAt(idx);

      meta.appendChild(name);
      meta.appendChild(del);

      card.appendChild(meta);
      listEl.appendChild(card);
    });
  }

  function initSortable(){
    if (sortable) sortable.destroy();
    sortable = new Sortable(listEl, {
      animation: 160,
      handle: ".handle",
      onEnd: () => {
        const orderIds = Array.from(listEl.children).map(el => el.dataset.id);
        items = orderIds.map(id => items.find(it => it.id === id));
        render();
        initSortable();
      }
    });
  }

  // ---------- PDF Helpers ----------
  function positionXY(pos, pageW, pageH, textW, fontSize){
    const margin = 24;
    let x = margin;
    let y = margin;

    // y: PDF origin is bottom-left
    if (pos.startsWith("top")) y = pageH - margin - fontSize;
    else if (pos.startsWith("mid") || pos === "center") y = (pageH / 2) - (fontSize / 2);
    else if (pos.startsWith("bottom")) y = margin;

    // x
    if (pos.endsWith("left")) x = margin;
    else if (pos.endsWith("center") || pos === "center") x = (pageW / 2) - (textW / 2);
    else if (pos.endsWith("right")) x = pageW - margin - textW;

    return { x, y };
  }

  async function createOutputPDF(){
    if (!items.length) return;

    createBtn.disabled = true;
    createBtn.textContent = "Creating‚Ä¶";
    prog.value = 0;
    progText.textContent = "Preparing‚Ä¶";

    try{
      const wmText = document.getElementById("wmText").value.trim();
      const wmPos = document.getElementById("wmPos").value;
      const wmRot = Number(document.getElementById("wmRotate").value || 0);
      const wmOp = Number(document.getElementById("wmOpacity").value || 0.2);

      const wmMode = document.getElementById("wmSizeMode").value;
      const wmCustomSize = Number(document.getElementById("wmFontSize").value || 48);

      const pnType = document.getElementById("pnType").value;
      const pnPos = document.getElementById("pnPos").value;
      const pnSize = Number(document.getElementById("pnFontSize").value || 12);

      // 1) Build output PDF (merge PDFs + convert images to pages)
      const outPdf = await PDFDocument.create();
      const helv = await outPdf.embedFont(StandardFonts.Helvetica);

      let totalPagesAdded = 0;

      for (let i = 0; i < items.length; i++){
        const it = items[i];
        progText.textContent = `Reading file ${i+1}/${items.length}‚Ä¶`;

        const buf = await it.file.arrayBuffer();

        if (it.kind === "pdf") {
          const srcPdf = await PDFDocument.load(buf);
          const pages = await outPdf.copyPages(srcPdf, srcPdf.getPageIndices());
          pages.forEach(p => outPdf.addPage(p));
          totalPagesAdded += pages.length;
        } else {
          // image: embed and add a page of the same image size (1px ~= 1pt)
          const isPng = (it.file.type || "").includes("png") || it.file.name.toLowerCase().endsWith(".png");
          const image = isPng ? await outPdf.embedPng(buf) : await outPdf.embedJpg(buf);
          const w = image.width;
          const h = image.height;

          const page = outPdf.addPage([w, h]);
          page.drawImage(image, { x: 0, y: 0, width: w, height: h });
          totalPagesAdded += 1;
        }

        prog.value = Math.round(((i+1) / items.length) * 60); // first 60%: building pages
      }

      pagesPill.textContent = `Total pages: ${totalPagesAdded}`;

      // 2) Apply watermark + page numbers on every page
      const pages = outPdf.getPages();
      const total = pages.length;

      for (let p = 0; p < total; p++){
        const page = pages[p];
        const { width: pageW, height: pageH } = page.getSize();

        // Watermark
        if (wmText){
          let wmSize = wmCustomSize;
          if (wmMode === "auto") {
            // auto based on page size
            wmSize = Math.max(18, Math.min(pageW, pageH) / 6);
          }
          const textW = helv.widthOfTextAtSize(wmText, wmSize);
          const { x, y } = positionXY(wmPos, pageW, pageH, textW, wmSize);

          page.drawText(wmText, {
            x, y,
            size: wmSize,
            font: helv,
            color: rgb(0.55, 0.55, 0.55),
            opacity: wmOp,
            rotate: degrees(wmRot)
          });
        }

        // Page numbers
        if (pnType !== "none"){
          const pnText = (pnType === "page")
            ? `Page ${p+1}`
            : `Page ${p+1} of ${total}`;

          const pnW = helv.widthOfTextAtSize(pnText, pnSize);
          const pnXY = positionXY(pnPos, pageW, pageH, pnW, pnSize);

          page.drawText(pnText, {
            x: pnXY.x,
            y: pnXY.y,
            size: pnSize,
            font: helv,
            color: rgb(0, 0, 0),
            opacity: 1
          });
        }

        prog.value = 60 + Math.round(((p+1) / total) * 40); // last 40%: stamping
        progText.textContent = `Applying watermark/page no‚Ä¶ ${p+1}/${total}`;
      }

      // 3) Download
      progText.textContent = "Finalizing‚Ä¶";
      const bytes = await outPdf.save();
      const blob = new Blob([bytes], { type: "application/pdf" });

      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = "output-watermarked.pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      prog.value = 100;
      progText.textContent = "Done ‚úÖ";
    } catch (err){
      console.error(err);
      progText.textContent = "Failed ‚ùå";
      alert("Failed to generate PDF. If the PDF is very large, try fewer pages/files.");
    } finally {
      createBtn.disabled = items.length === 0;
      createBtn.textContent = "Create PDF";
    }
  }

  // init labels
  wmOpacityLabel.textContent = Number(wmOpacity.value).toFixed(2);
</script>

</body>
</html>
